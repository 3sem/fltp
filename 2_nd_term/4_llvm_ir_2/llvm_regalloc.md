## аллокация регистров в LLVM

 В инфраструктуре LLVM этот процесс реализуется через набор алгоритмов, которые применяются в зависимости от целей оптимизации и особенностей целевой архитектуры.

### Этапы аллокации регистров

Процесс аллокации регистров в LLVM состоит из нескольких этапов:

1. **Анализ живых диапазонов (live range analysis)**:
   Определяются интервалы жизни каждой переменной, то есть участки кода, в которых переменная активно используется. Эти интервалы называются живыми диапазонами.

2. **Построение графа интерференций (interference graph)**:
   Строится граф, где каждая вершина представляет переменную, а рёбра соединяют пары переменных, которые не могут находиться в одном регистре одновременно (интерферентные переменные).

3. **Раскраска графа (graph coloring)**:
   Задача сводится к назначению цветов (регистров) вершинам графа так, чтобы смежные вершины имели разные цвета. Если количество регистров ограничено, некоторые переменные могут быть временно выгружены в память (процесс называется spilling).

4. **Спиллинг (spilling)**:
   Переменные, которым не хватило регистров, сохраняются в стековую память. Затем, когда эти переменные снова понадобятся, они загружаются обратно в регистр.

### Алгоритмы аллокации регистров в LLVM

LLVM поддерживает несколько алгоритмов аллокации регистров:

1. **Linear Scan Register Allocation**:
   Простой и быстрый алгоритм, который сканирует живые диапазоны переменных последовательно и назначает регистры в порядке их появления. Однако он не учитывает структуру графа интерференций и может приводить к неоптимальному использованию регистров.

2. **Graph Coloring Register Allocation**:
   Более сложный и эффективный алгоритм, основанный на раскраске графа интерференций. Граф строится на основе живых диапазонов, и задача сводится к поиску такой раскраски, при которой смежные вершины имеют разные цвета. Если граф нельзя раскрасить заданным количеством цветов, происходит спиллинг.

3. **Iterated Register Coalescing**:
   Улучшенная версия алгоритма графовой окраски, которая дополнительно пытается объединить смежные вершины (коалесцировать), чтобы уменьшить количество необходимых регистров.

4. **PBQP Register Allocation**:
   Алгоритм, использующий псевдобулевы методы для решения задачи аллокации регистров. Он стремится найти оптимальное решение, учитывая ограничения на ресурсы и зависимости между переменными.

### Пример использования LLC

Рассмотрим пример использования команды `llc` для получения информации о работе алгоритмов аллокации регистров. Предположим, у нас есть следующий фрагмент кода на языке С:

```c
int foo(int a, int b) {
    return a + b;
}
```

Этот код можно перевести в LLVM IR с помощью команды `clang`, а затем обработать с помощью `llc`. Для этого создадим файл `test.c` с содержимым:

```bash
clang -S -emit-llvm test.c -o test.ll
llc -march=x86-64 -O3 -stats -o output.s test.ll
```

В результате выполнения `llc` будет создан файл `output.s` с ассемблерным кодом, а также выведена статистика выполнения различных этапов компиляции, включая аллокацию регистров. Вот пример части вывода:

```bash
...
--- Pass execution timing summary ---
 Total Execution Time: 0.145 seconds (0.135 user, 0.010 sys)
   ---Total time in passes: 0.144 seconds---
   Individual pass timings (all times are in milliseconds):
      Name            Time     CPU time (self)   Impl.   Calls        Objects
      ============   =======   ===============   =====   ======   ==============
      regalloc       15.600    14.200            C++     1           34567
      sched          18.000    19.800            C++     1           24561
      sccp           7.400     8.900             C++     1           13279
      loop-vectorize 31.200    32.700            C++     1           45678
      ...
```

на этап аллокации регистров (`regalloc`) было потрачено около 15 миллисекунд.
### выбор алгоритма в LLC
Для задания алгоритма аллокации регистров в llc используется опция -regalloc=<algorithm>, где <algorithm> заменяется названием нужного алгоритма. Рассмотрим доступные варианты:
linear-scan:
Простой алгоритм линейного сканирования, который просматривает живые диапазоны переменных и назначает регистры по мере их появления. Быстр, но может привести к неоптимальной аллокации.
local:
Локальная аллокация регистров, применяемая внутри одной базовой блока (Basic Block). Этот метод хорошо подходит для небольших фрагментов кода.
simple:
Базовый алгоритм, похожий на линейное сканирование, но с улучшенными эвристиками для уменьшения числа спиллов (выгрузки переменных в память).
basic:
Алгоритм графовой окраски, более сложный и точный, но медленнее предыдущих. Использует графовые структуры для поиска оптимальной аллокации регистров.
greedy:
Жадный алгоритм, основанный на принципе жадного выбора регистра с учетом приоритета и стоимости спилла.
pbqp:
Алгоритм псевдо-булевой оптимизации, который пытается найти глобально оптимальное решение задачи аллокации регистров.
Пример использования опции -regalloc

Предположим, вам нужно применить алгоритм линейного сканирования для аллокации регистров. Вы можете запустить llc следующей командой:

llc -march=x86_64 -O3 -regalloc=linear-scan -o output.s input.ll
